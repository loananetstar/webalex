================================================================================
              COMPLETE MQTT INTEGRATION GUIDE FOR FRONTEND
                           (FINAL VERSION)
================================================================================

Last Updated: January 11, 2026
Backend: unified_app.py (Multi-Threaded Architecture)
Status: ALL CRITICAL ISSUES FIXED

================================================================================
SECTION 1: CONNECTION SETUP
================================================================================

MQTT BROKER DETAILS:
--------------------
Host:     33d2caf18f7944cbb4ea3a8d2b8cba30.s1.eu.hivemq.cloud
Port:     8883 (TLS/SSL Required)
Username: davinn
Password: Loana123*
Protocol: MQTT v5 (Recommended) or v3.1.1

JAVASCRIPT EXAMPLE (MQTT.js):
------------------------------
const mqtt = require('mqtt');

const client = mqtt.connect('mqtts://33d2caf18f7944cbb4ea3a8d2b8cba30.s1.eu.hivemq.cloud:8883', {
  username: 'davinn',
  password: 'Loana123*',
  clientId: 'frontend_' + Math.random().toString(16).substr(2, 8),
  clean: true,
  reconnectPeriod: 1000
});

client.on('connect', () => {
  console.log('Connected to MQTT Broker');
  
  // Subscribe to ALL response topics
  client.subscribe('/user2/0');                      // Auth responses
  client.subscribe('/note/status');                  // Note status updates
  client.subscribe('gacor/1');                       // Note results (INLINE CONTENT!)
  client.subscribe('history/1');                     // History responses
  client.subscribe('dashboard/response');            // Dashboard data
  client.subscribe('alex/dashboard/state/response'); // Heartbeat responses
  client.subscribe('memory/activity/response');      // Memory search results
  client.subscribe('memory/stats/response');         // Memory stats
  client.subscribe('memory/base/response');          // NEW: Core memories
  client.subscribe('memory/context/response');       // NEW: Recent context
  client.subscribe('/agent/status');                 // NEW: Agent status feedback
});

================================================================================
SECTION 2: COMPLETE TOPIC REFERENCE TABLE
================================================================================

ACTION                  | PUBLISH TO              | PAYLOAD            | RESPONSE TOPIC
------------------------|-------------------------|--------------------|--------------------------
Auth Gmail              | /user1/0                | AUTH:GMAIL         | /user2/0
Auth Calendar           | /user1/0                | AUTH:CALENDAR      | /user2/0
Auth Drive              | /user1/0                | AUTH:DRIVE         | /user2/0
Auth Classroom          | /user1/0                | AUTH:GCLASSROOM    | /user2/0
Auth Spotify            | /user1/0                | AUTH:SPOTIFY       | /user2/0
Start Recording         | /note/1                 | NOTEON             | /note/status
Stop Recording          | /note/1                 | NOTEOFF            | /note/status, gacor/1
Get Last Note           | /note/1                 | GET_SUMMARIZE      | gacor/1
Start Agent             | /agent/1                | AGENTON            | /agent/status (NEW!)
Stop Agent              | /agent/1                | AGENTOFF           | /agent/status (NEW!)
Request Dashboard       | dashboard/request       | GET                | dashboard/response
Request Heartbeat       | alex/dashboard/state/   | (empty)            | alex/dashboard/state/
                        | request                 |                    | response
Request History         | history/2               | check_history      | history/1
Search Activities       | memory/activity/search  | {"query": "*"}     | memory/activity/response
Request Memory Stats    | memory/stats/request    | GET                | memory/stats/response
Get Base Memory (NEW!)  | memory/base/request     | GET                | memory/base/response
Get Context (NEW!)      | memory/context/request  | GET                | memory/context/response

================================================================================
SECTION 3: AUTHENTICATION SYSTEM
================================================================================

3.1 TRIGGER AUTHENTICATION
---------------------------
TOPIC:   /user1/0
PAYLOAD: "AUTH:GMAIL" | "AUTH:CALENDAR" | "AUTH:DRIVE" | "AUTH:GCLASSROOM" | "AUTH:SPOTIFY"

Example:
  client.publish('/user1/0', 'AUTH:GMAIL');

3.2 RECEIVE AUTHENTICATION LINK
--------------------------------
TOPIC:   /user2/0
PAYLOAD: <OAuth URL> | "SUCCESS:GMAIL" | "TIMEOUT" | "ERROR:..." | "AUTH_BUSY"

Flow:
1. Frontend sends: /user1/0 → "AUTH:GMAIL"
2. Backend responds: /user2/0 → "https://accounts.google.com/o/oauth2/auth?..."
3. Open URL in browser/iframe
4. User completes OAuth
5. Backend sends: /user2/0 → "SUCCESS:GMAIL"

CONFIRMED WORKING AUTH COMMANDS:
- AUTH:GMAIL    → Gmail scopes only
- AUTH:CALENDAR → Calendar scopes only
- AUTH:DRIVE    → Drive scopes only
- AUTH:GCLASSROOM → Classroom scopes only
- AUTH:SPOTIFY  → Spotify OAuth

================================================================================
SECTION 4: NOTE TAKER SYSTEM (CRITICAL FIX APPLIED)
================================================================================

4.1 START RECORDING
-------------------
TOPIC:   /note/1
PAYLOAD: "NOTEON"

4.2 STOP RECORDING & PROCESS
-----------------------------
TOPIC:   /note/1
PAYLOAD: "NOTEOFF"

4.3 RECEIVE STATUS UPDATES
---------------------------
TOPIC:   /note/status
PAYLOAD: JSON

Status Types:
{"status": "RECORDING", "duration": 30}
{"status": "TRANSCRIBING", "progress": 0}
{"status": "PROCESSING", "progress": 60, "message": "Generating 7 artifacts..."}
{"status": "COMPLETE", "session_id": "note_20260111_103045"}
{"status": "ERROR", "message": "Transcription failed"}

4.4 RECEIVE FINAL RESULTS (FIX: NOW SENDS INLINE CONTENT!)
-----------------------------------------------------------
TOPIC:   gacor/1
PAYLOAD: JSON with INLINE CONTENT (not file paths!)

BEFORE (BROKEN):
{
  "artifacts": {
    "flashcards": "C:\\Users\\ASUS\\Downloads\\genai\\data\\notes\\...\\flashcards.json"
  }
}

AFTER (FIXED):
{
  "type": "note_summary",
  "session_id": "note_20260111_103045",
  "duration_minutes": 5,
  "timestamp": "2026-01-11T10:35:12",
  "artifacts": {
    "master_guide": "# Lecture Notes\n\n## Topic 1\nContent here...",
    "flashcards": [
      {"front": "Question 1?", "back": "Answer 1"},
      {"front": "Question 2?", "back": "Answer 2"}
    ],
    "quiz": [
      {
        "question": "What is X?",
        "options": ["A", "B", "C", "D"],
        "answer": "B"
      }
    ],
    "mindmap": "mindmap\n  root((Topic))\n    Branch1\n    Branch2",
    "cornell_notes": "## Main Notes\n...",
    "spaced_repetition": [...],
    "citation_index": [...]
  },
  "stats": {
    "total_flashcards": 12,
    "agents_successful": 3
  },
  "preview_text": "This lecture covered..."
}

FRONTEND USAGE:
---------------
// Flashcards - DIRECTLY USE THE ARRAY
const flashcards = data.artifacts.flashcards; // Array of {front, back}

// Quiz - DIRECTLY USE THE ARRAY
const quiz = data.artifacts.quiz; // Array of {question, options, answer}

// Mindmap - DIRECTLY USE THE STRING
const mindmapCode = data.artifacts.mindmap; // Raw Mermaid.js code

// Check for null (failed generation)
if (data.artifacts.flashcards === null) {
  console.log('Flashcards not generated');
}

================================================================================
SECTION 5: LIVE AGENT SYSTEM (NEW: STATUS FEEDBACK!)
================================================================================

5.1 START AGENT
---------------
TOPIC:   /agent/1
PAYLOAD: "AGENTON"

5.2 STOP AGENT
--------------
TOPIC:   /agent/1
PAYLOAD: "AGENTOFF"

5.3 RECEIVE AGENT STATUS (NEW!)
--------------------------------
TOPIC:   /agent/status
PAYLOAD: JSON

Status Sequence When Starting:
1. Send AGENTON
2. Receive: {"status": "starting", "timestamp": "..."}
3. Receive: {"status": "running", "mode": "active", "timestamp": "..."}

Status When Stopping:
1. Send AGENTOFF
2. Receive: {"status": "stopped", "timestamp": "..."}

Status During Note Taker (Auto-Pause):
- {"status": "running", "mode": "paused", "timestamp": "..."}
- {"status": "running", "mode": "active", "timestamp": "..."}

FRONTEND USAGE:
---------------
client.on('message', (topic, payload) => {
  if (topic === '/agent/status') {
    const data = JSON.parse(payload.toString());
    setAgentStatus(data.status);  // "starting" | "running" | "stopped"
    setAgentMode(data.mode);      // "active" | "paused" (when running)
  }
});

================================================================================
SECTION 6: DASHBOARD & HEARTBEAT
================================================================================

6.1 REQUEST DASHBOARD DATA
---------------------------
TOPIC:   dashboard/request
PAYLOAD: "GET"

6.2 RECEIVE DASHBOARD DATA
---------------------------
TOPIC:   dashboard/response
PAYLOAD: JSON

{
  "status": "success",
  "timestamp": "2026-01-11T10:40:15.285396+00:00",
  "services": {
    "gmail": {"status": "connected", "email": "user@example.com"},
    "spotify": {"status": "connected", "user": "john_doe"},
    "calendar": {"status": "not_connected"}
  },
  "note_taker": {
    "status": "idle",
    "last_session": "note_20260111_103045"
  },
  "agent": {
    "status": "running",
    "mode": "active"
  },
  "memory": {
    "total_facts": 1234,
    "core_memories": 56
  }
}

6.3 REQUEST HEARTBEAT
---------------------
TOPIC:   alex/dashboard/state/request
PAYLOAD: "" (empty)

6.4 RECEIVE HEARTBEAT
---------------------
TOPIC:   alex/dashboard/state/response
PAYLOAD: JSON

{"status": "alive", "timestamp": "2026-01-11T10:40:30"}

================================================================================
SECTION 7: HISTORY & MEMORY SYSTEM
================================================================================

7.1 REQUEST CONVERSATION HISTORY
---------------------------------
TOPIC:   history/2
PAYLOAD: "check_history"

7.2 RECEIVE HISTORY
-------------------
TOPIC:   history/1
PAYLOAD: JSON

{
  "type": "timeline_feed",
  "data": [
    {"timestamp": "2026-01-11T10:30:00", "role": "user", "text": "What's the weather?"},
    {"timestamp": "2026-01-11T10:30:05", "role": "model", "text": "I'll check..."}
  ]
}

7.3 SEARCH MEMORY ACTIVITIES
-----------------------------
TOPIC:   memory/activity/search
PAYLOAD: JSON

{"query": "*", "limit": 50}
{"query": "note_taken", "limit": 10}

7.4 RECEIVE SEARCH RESULTS
---------------------------
TOPIC:   memory/activity/response
PAYLOAD: JSON Array (NOT object with wrapper!)

[
  {
    "id": 123,
    "activity_type": "note_taken",
    "activity_data": {"session_id": "note_xxx", "duration_minutes": 5},
    "timestamp": "2026-01-11T10:35:12"
  }
]

7.5 REQUEST MEMORY STATS
-------------------------
TOPIC:   memory/stats/request
PAYLOAD: "GET"

7.6 RECEIVE MEMORY STATS
-------------------------
TOPIC:   memory/stats/response
PAYLOAD: JSON

{
  "total": 2276,
  "by_activity_type": {"note_taken": 45, "auth_event": 12},
  "memories": {"total": 1234, "by_type": {"fact": 500, "preference": 234}}
}

================================================================================
SECTION 8: BASE MEMORY SYSTEM (NEW!)
================================================================================

This fixes the "fake data" problem in Base Memory and Recent Context tabs.

8.1 REQUEST BASE MEMORY (Core Facts)
-------------------------------------
TOPIC:   memory/base/request
PAYLOAD: "GET" (any string works)

8.2 RECEIVE BASE MEMORY
------------------------
TOPIC:   memory/base/response
PAYLOAD: JSON

{
  "timestamp": "2026-01-11T12:30:00",
  "status": "success",
  "data": {
    "identities": [
      {"text": "User's name is John", "confidence": 0.95},
      {"text": "User is a student", "confidence": 0.88}
    ],
    "deep_facts": [
      {"text": "User studies computer science at MIT", "confidence": 0.92},
      {"text": "User prefers Python over JavaScript", "confidence": 0.78}
    ],
    "preferences": [
      {"text": "User likes concise explanations", "confidence": 0.85},
      {"text": "User prefers dark mode", "confidence": 0.72}
    ]
  }
}

FRONTEND USAGE:
---------------
// Request base memory
client.publish('memory/base/request', 'GET');

// Handle response
client.on('message', (topic, payload) => {
  if (topic === 'memory/base/response') {
    const data = JSON.parse(payload.toString());
    setIdentities(data.data.identities);
    setDeepFacts(data.data.deep_facts);
    setPreferences(data.data.preferences);
  }
});

8.3 REQUEST RECENT CONTEXT (LLM Input)
---------------------------------------
TOPIC:   memory/context/request
PAYLOAD: "GET"

8.4 RECEIVE RECENT CONTEXT
---------------------------
TOPIC:   memory/context/response
PAYLOAD: JSON

{
  "timestamp": "2026-01-11T12:30:00",
  "status": "success",
  "data": {
    "recent_contexts": [
      {
        "text": "User asked about Python programming basics...",
        "timestamp": "2026-01-11T12:25:00",
        "session_id": "session_abc123"
      },
      {
        "text": "Discussed machine learning concepts...",
        "timestamp": "2026-01-11T12:20:00",
        "session_id": "session_abc123"
      }
    ],
    "conversation_buffer": [
      "User: Hello Alex",
      "Model: Hi! How can I help?",
      "User: Tell me about Python"
    ]
  }
}

FRONTEND USAGE:
---------------
// Request recent context
client.publish('memory/context/request', 'GET');

// Handle response
client.on('message', (topic, payload) => {
  if (topic === 'memory/context/response') {
    const data = JSON.parse(payload.toString());
    setRecentContexts(data.data.recent_contexts);
    setConversationBuffer(data.data.conversation_buffer);
  }
});

================================================================================
SECTION 9: ERROR HANDLING
================================================================================

9.1 COMMON ERROR RESPONSES
---------------------------
{
  "type": "error",
  "message": "Handler returned No Data",
  "code": "NO_DATA"
}

{
  "error": "Memory system not available"
}

{
  "error": "AdvancedMemory not available"
}

9.2 TIMEOUT HANDLING
---------------------
If no response within 25 seconds:
1. Show timeout error to user
2. Check heartbeat (alex/dashboard/state/request)
3. If heartbeat fails, backend is down
4. Retry once after 5 seconds

================================================================================
SECTION 10: COMPLETE REACT EXAMPLE
================================================================================

import mqtt from 'mqtt';
import { useEffect, useState } from 'react';

function App() {
  const [client, setClient] = useState(null);
  const [noteStatus, setNoteStatus] = useState('idle');
  const [agentStatus, setAgentStatus] = useState('stopped');
  const [flashcards, setFlashcards] = useState([]);
  const [baseMemory, setBaseMemory] = useState(null);

  useEffect(() => {
    const mqttClient = mqtt.connect('mqtts://33d2caf18f7944cbb4ea3a8d2b8cba30.s1.eu.hivemq.cloud:8883', {
      username: 'davinn',
      password: 'Loana123*',
      clientId: 'react_' + Math.random().toString(16).substr(2, 8)
    });

    mqttClient.on('connect', () => {
      console.log('Connected to MQTT');
      mqttClient.subscribe('/note/status');
      mqttClient.subscribe('gacor/1');
      mqttClient.subscribe('/agent/status');
      mqttClient.subscribe('memory/base/response');
      mqttClient.subscribe('memory/context/response');
    });

    mqttClient.on('message', (topic, payload) => {
      const data = JSON.parse(payload.toString());
      
      switch(topic) {
        case '/note/status':
          setNoteStatus(data.status);
          break;
        case 'gacor/1':
          // Flashcards are now INLINE - use directly!
          if (data.artifacts?.flashcards) {
            setFlashcards(data.artifacts.flashcards);
          }
          break;
        case '/agent/status':
          setAgentStatus(data.status);
          break;
        case 'memory/base/response':
          setBaseMemory(data.data);
          break;
      }
    });

    setClient(mqttClient);
    return () => mqttClient.end();
  }, []);

  const startRecording = () => client?.publish('/note/1', 'NOTEON');
  const stopRecording = () => client?.publish('/note/1', 'NOTEOFF');
  const startAgent = () => client?.publish('/agent/1', 'AGENTON');
  const stopAgent = () => client?.publish('/agent/1', 'AGENTOFF');
  const getBaseMemory = () => client?.publish('memory/base/request', 'GET');

  return (
    <div>
      <h1>Alex Dashboard</h1>
      
      <section>
        <h2>Note Taker ({noteStatus})</h2>
        <button onClick={startRecording}>Start Recording</button>
        <button onClick={stopRecording}>Stop Recording</button>
        
        {flashcards.length > 0 && (
          <div>
            <h3>Flashcards ({flashcards.length})</h3>
            {flashcards.map((card, i) => (
              <div key={i}>
                <strong>Q:</strong> {card.front}
                <br/>
                <strong>A:</strong> {card.back}
              </div>
            ))}
          </div>
        )}
      </section>

      <section>
        <h2>Agent ({agentStatus})</h2>
        <button onClick={startAgent}>Start Agent</button>
        <button onClick={stopAgent}>Stop Agent</button>
      </section>

      <section>
        <h2>Memory</h2>
        <button onClick={getBaseMemory}>Load Base Memory</button>
        {baseMemory && (
          <div>
            <h3>Identities</h3>
            {baseMemory.identities.map((m, i) => (
              <p key={i}>{m.text} ({Math.round(m.confidence * 100)}%)</p>
            ))}
          </div>
        )}
      </section>
    </div>
  );
}

export default App;

================================================================================
SECTION 11: TROUBLESHOOTING
================================================================================

PROBLEM: Flashcards still shows file path
SOLUTION: Restart backend. Run: python unified_app.py

PROBLEM: Agent status not updating
SOLUTION: Subscribe to /agent/status topic

PROBLEM: Base memory shows error
SOLUTION: Memory system needs data. Interact with agent first.

PROBLEM: No response from any topic
SOLUTION: Check heartbeat first (alex/dashboard/state/request)

PROBLEM: MQTT connection fails
SOLUTION: Check credentials and port (8883, TLS required)

================================================================================
SUMMARY OF FIXES APPLIED
================================================================================

| Issue | Before | After |
|-------|--------|-------|
| Note Artifacts | Sent C:\ file paths | Sends INLINE JSON content |
| Base Memory | No endpoint | memory/base/request → response |
| Recent Context | No endpoint | memory/context/request → response |
| Agent Status | No feedback | /agent/status sends starting/running/stopped |
| Auth Commands | Worked | Confirmed: AUTH:GMAIL, AUTH:CALENDAR, etc. all work |

================================================================================
EOF - GUIDE VERSION 2.0 (COMPLETE)
================================================================================
