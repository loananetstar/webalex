# MQTT Protocol Guide v4.0 "Strict" Edition
# Backend Requirements Specification

## Critical Design Rules (STRICT ENFORCEMENT)
1. **Reactive Only**: Backend NEVER sends data unprompted (except Note status). Frontend MUST request data.
2. **Rate Limiting**: Backend MUST ignore requests from same client/topic if < 500ms apart.
3. **Guaranteed Response**: Every request MUST get a JSON response. Even errors.
   - Error Format: `{"type": "error", "message": "Reason..."}`
4. **Null Handling**: Missing fields = `null`. NEVER empty strings/objects.
   - Example: `{"artifacts": null}` NOT `{"artifacts": {}}` or `""`.
5. **Strict Enums**: Unknown values in 'type' or 'status' fields = ERROR response.

---

## 1. Authentication (Google / Spotify)
**Topic**: `/user1/0` (Request) -> `/user2/0` (Response)

### Requests (Frontend -> Backend)
- **Google**: `AUTH:GOOGLE`
- **Spotify**: `AUTH:SPOTIFY`

### Responses (Backend -> Frontend)
- **Log URL**: `https://accounts.google.com/o/oauth2/...` (Frontend opens this)
- **Success**: `SUCCESS:GOOGLE` or `SUCCESS:SPOTIFY`
- **Error**: `ERROR:TIMEOUT`, `ERROR:INVALID_SCOPE`

---

## 2. Notes & Audio
**Topic**: `/note/1` (Control) -> `/note/status` (Progress) -> `gacor/1` (Result)

### Control (Frontend -> Backend)
- `NOTEON`: Start recording.
- `NOTEOFF`: Stop recording.

### Status Updates (Backend -> Frontend)
- **Topic**: `/note/status`
- **Payload**:
```json
{
  "status": "RECORDING" | "TRANSCRIBING" | "PROCESSING" | "COMPLETE" | "ERROR",
  "progress": 0-100, // Number
  "message": "Step description..." // String or null
}
```

### Final Result (Backend -> Frontend)
- **Topic**: `gacor/1`
- **Payload**:
```json
{
  "type": "note_summary",
  "session_id": "uuid-string",
  "timestamp": "ISO-8601",
  "duration_minutes": 5,
  "preview_text": "Summary of the note...",
  "artifacts": {
    "master_guide": "C:\\Users\\User\\...\\master_guide.md", // Absolute Path or null
    "flashcards": "C:\\Users\\User\\...\\flashcards.json",
    "quiz": null,
    "mindmap": null,
    "cornell_notes": "C:\\Users\\User\\...\\cornell.md",
    "spaced_repetition": null,
    "citation_index": null
  },
  "stats": {
    "word_count": 450,
    "audio_size_mb": 2.4
  }
}
```
*Note: Artifacts are file paths. Frontend displays them but cannot open them directly without backend file serving.*

---

## 3. Memory & Activity
**Topic**: `memory/activity/search` -> `memory/activity/response`
**Topic**: `memory/stats/request` -> `memory/stats/response`

### Activity Search
- **Request**:
```json
{
  "query": "search term" | "",
  "activity_type": "auth_event" | "note_taken" | "dashboard_access" | "note_session" | null,
  "days_back": 30, // Default 30
  "limit": 20      // Default 20
}
```
- **Response** (`memory/activity/response`):
```json
{
  "results": [
    {
      "id": 123,
      "activity_type": "note_taken", // STRICT ENUM: auth_event, note_taken, dashboard_access, note_session
      "timestamp": "ISO-8601",
      "activity_data": { "title": "Math Class", "duration": "5m" } // Arbitrary Object
    }
  ]
}
```

### Memory Stats
- **Request**: `get_stats`
- **Response** (`memory/stats/response`):
```json
{
  "total": 1500,
  "last_24h": 12,
  "by_type": {
    "auth_event": 50,
    "note_taken": 200,
    "dashboard_access": 1000,
    "note_session": 250
  }
}
```

---

## 4. Dashboard & System
**Topic**: `dashboard/request` -> `dashboard/response`
**Topic**: `alex/dashboard/state/request` -> `alex/dashboard/state/response`

### Dashboard Data
- **Request**: `GET` (Rate Limit: 1 request per 30s)
- **Response**:
```json
{
  "weather": { "temp": 28, "condition": "Sunny", "location": "Jakarta" },
  "integrations": {
    "GOOGLE": true,
    "SPOTIFY": false
  }
}
```

### Agent Heartbeat
- **Request**: `ping` (Rate Limit: 1 request per 5s)
- **Response**:
```json
{
  "is_active": true,
  "battery_level": 85,
  "is_connected": true,
  "active_status_message": "Online and listening"
}
```

## 5. Agent Control
**Topic**: `/agent/1`
- `AGENTON`: Wake agent.
- `AGENTOFF`: Sleep agent.
- *No Response payload defined in v4.0 (Fire and Forget or Status update via Heartbeat).*
